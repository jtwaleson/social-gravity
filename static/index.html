<html>
	<head>
		<title>Twitter network analysis</title>
		<script type='text/javascript' src='js/external/jquery.old.min.js'></script>
		<script type='text/javascript' src='js/external/bootstrap_modal.js'></script>
		<script type='text/javascript' src='js/external/jquery.mousewheel.min.js'></script>
		<script type='text/javascript' src='js/external/jquery-ui-1.8.16.custom.min.js'></script>
		<script type='text/javascript' src='js/external/jquery.jgrowl.min.js'></script>
		<script type='text/javascript' src='js/external/jquery.jgrowl.min.js'></script>
		<script type='text/javascript' src='js/external/shortcut.js'></script>
		<script type='text/javascript' src='js/downloader.js'></script>
		<script type='text/javascript' src='js/friendmanager.js'></script>
		<script type='text/javascript' src='js/friend.js'></script>
		<script type='text/javascript' src='js/viewport.js'></script>
		<script type='text/javascript' src='js/protagonists.js'></script>
		<script type='text/javascript' src='js/simulation.js'></script>
		<script type='text/javascript'>
		
var downloader = new Downloader();
var simulation = new Simulation();
var viewPort = new ViewPort();
var friendManager = new FriendManager(viewPort, simulation, downloader);
var protagonists= new Protagonists(downloader);

(function($){
$.fn.disableSelection = function() {
return this.each(function() { 
	$(this).attr('unselectable', 'on')
	 .css({
		 '-moz-user-select':'none',
		 '-webkit-user-select':'none',
		 'user-select':'none'
	 })
	 .each(function() {
		 this.onselectstart = function() { return false; };
	 });
});
};

})(jQuery);

$(function() {
$("#playfield").html("<canvas width='"+(viewPort.getWidth()*5)+"px' height='"+(viewPort.getHeight()*5)+"px' id='c'/>");
$("#playfield").mousewheel(function(e, delta) {
	e.preventDefault();
	viewPort.dozoom((delta == 1 ? 0.5 : 2), {x : e.pageX, y : e.pageY});
});
$("#running .stop").click(function(e) { $.jGrowl("Stopping calculation engine"); e.preventDefault(); simulation.stop();});
$("#running .start").click(function(e) { $.jGrowl("Starting calculation engine"); e.preventDefault(); simulation.start();});
$(".strongconnections").click(function(e) { e.preventDefault(); friendManager.toggleDrawStrongConnections();});
$("#thresholdslider").slider({min: 1, max: 2, val:1, step: 1, change: function(){protagonists.generate()}});
$("#networkgenerator").click(function(e) {
	$("#modal-network-generator").modal({keyboard: true, backdrop: 'static', show: true});
	setTimeout(
		function() { $("#modal-network-generator input[type=text]").focus();},
		500
	);
});
shortcut.add("s", function(){friendManager.toggleDrawStrongConnections(); return false;}, {disable_in_input: true});
shortcut.add("Ctrl+up", function(){viewPort.dozoom(0.5);}, {disable_in_input: true});
shortcut.add("Ctrl+down", function(){viewPort.dozoom(2);}, {disable_in_input: true});
shortcut.add("up", function(){viewPort.move(1);}, {disable_in_input: true});
shortcut.add("down", function(){viewPort.move(3)}, {disable_in_input: true});
shortcut.add("left", function(){viewPort.move(0)}, {disable_in_input: true});
shortcut.add("right", function(){viewPort.move(2)}, {disable_in_input: true});
shortcut.add("space", function(){$("#running a:visible").click()}, {disable_in_input: true});
shortcut.add("n", function(){simulation.filter(1)}, {disable_in_input: true});
shortcut.add("m", function(){simulation.filter(-1)}, {disable_in_input: true});
$("#addProtagonist").submit(function(e){
	e.preventDefault();
	protagonists.add($("#addProtagonistText").val());
	$("#addProtagonistText").val('')
})
$(".rmprotagonist").live('click', function(e) {
	protagonists.rm($(this).closest('tr').attr('rel'));
})
$(".newnetwork").click(function(e) {
	e.preventDefault();
	protagonists.clear();
	for (var i in friendManager.persons) {
		if (friendManager.persons[i].drawlines) {
			protagonists.add(friendManager.persons[i].div.text());
		}
	}
	$("#networkgenerator").click();
});
$("#configurebtn").click(function(e){
	e.preventDefault();
	if ($(this).is('.disabled'))
		return;
	$("#modal-tweep-downloader").modal('hide');
	$("#modal-connection-configurator").modal({keyboard: true, backdrop: 'static', show: true});
})
$("#analysebtn").click(function(e){
	e.preventDefault();
	if ($(this).is('.disabled'))
		return;
	$("#modal-connection-configurator").modal('hide');
	friendManager.getInnerConnections();
})
$("#downloadbtn").click(function(e) {
	e.preventDefault();
	if ($(this).is('.disabled'))
		return;
	$("#modal-network-generator").modal('hide');
	$("#modal-tweep-downloader").modal({keyboard: true, backdrop: 'static', show: true});
	$("#downloadsphase1").show();
	$("#downloadsphase2").hide();
	$("#analysebtn").addClass('disabled');
	$("#progress").show();
	$("#pleasecomeback").hide();
	
	$(".tweepProfilesParsed").text('0');
	var profilesincache = 0;
	friendManager.clear();
	for (var i in protagonists.getActualFriendsAndFollowers()) {
		friendManager.add(i);
		if (friendManager.persons[i].hasinfo)
			profilesincache++;
	}
	$(".tweepProfilesCached").text(profilesincache);
	
	downloader.readyCallback = function() {
		$("#downloadsphase2").fadeIn('slow');
		friendManager.phase = -1;
		friendManager.startDownloading();
	}
	setTimeout(function(){friendManager.getProfiles();}, 1000);
});
$("#protagonists input").live('change', function(e) {
	protagonists.change($(this).closest('tr').attr('rel'), $(this).attr('rel'));
});

$("#modal-connection-configurator .checkbox").each(function(){
	$('<div>').html('<input type="checkbox">').appendTo($(this));
	$('<p>').append($('<b>').html($(this).attr('data-caption'))).prependTo($(this));
	$('<p>').html($(this).attr('data-text')).appendTo($(this));
	$(this).find('input').attr('checked', $(this).attr('data-default') == 'true').change(function(){
		alert($(this).is(":checked"));
	});

});
$("#modal-connection-configurator .slider").each(function(){
	$('<div>').slider({
		slide: function(){
			$(this).parent().find('.amount').text($(this).slider('value')); 
			simulation.settings[$(this).parent().attr('data-tag')] = $(this).slider('value');
		},
		change: function() {
			$(this).parent().find('.amount').text($(this).slider('value')); 
			simulation.settings[$(this).parent().attr('data-tag')] = $(this).slider('value');
		},
		min: parseFloat($(this).attr('data-min')),
		step: parseFloat($(this).attr('data-step')),
		max: parseFloat($(this).attr('data-max'))
	}).addClass('realslider').appendTo($(this));
	$('<p>').append($('<b>').html($(this).attr('data-caption'))).prependTo($(this));
	$('<p>').html($(this).attr('data-text').replace('..','<span class="amount"></span>')).appendTo($(this));
	$(this).find('.realslider').slider('value', parseFloat($(this).attr('data-default')));

});

});





		</script>
		<script type='text/javascript'>
			function rand(mi,ma) {
				return mi + (Math.floor(Math.random()*(ma-mi)));
			}
		</script>
		
		<link rel="stylesheet" href="css/bootstrap.min.css">
		<link rel="stylesheet" href="css/smoothness/jquery-ui-1.8.16.custom.css">
		<link rel="stylesheet" href="css/jquery.jgrowl.css">
		<style type='text/css'>





body {
	padding-top: 40px;
	position: relative;
	overflow: hidden;
	height: 100%;
}
.container {
	width: 100%;
}
#networkgenerator {
	margin-top: 5px;
}
#playfield {
	background-color: white;
	left: 0;
	height: 100%;
	width: 100%;
	top: 0;
	position: absolute;
}
#c {
	position: absolute;
	left: 0;
	top: 0;
}
#playfield .friend {
	cursor: default;
	font-size: x-small;
	border: 1px solid green;
	position: absolute;
	background-color: #eee;
	border-radius: 3px;
	padding: 0 3px;
}
body #playfield .friend:hover {
	opacity: 1.0;
	color: white;
	background-color: black;
}
#playfield .friend.gray {
	border: 1px solid #ddd;
	background-color: #eee;
	color: #999;
}
#playfield .friend.halfgray {
	border: 1px solid red;
	background-color: red;
}
body #playfield .friend.immovable{
	border-left: 7px solid black;
	border-right: 7px solid black;
}
#playfield .friend.highlight {
	background-color: blue;
	color: white;
}
#playfield .friend.highlight2 {
	background-color: red;
	color: white;
}
#playfield .friend.highlight.highlight2 {
	background-color: purple;
}
#playfield .friend.clicked {
	border-width: 3px;
}
#modal-network-generator input[type=text] {
	height: 28px;
}
#modal-network-generator td {
	line-height: 28px;
}







		</style>
	</head>
	<body>
		<div class='topbar'>
			<div class='fill'>
				<div class='container'>
					<a class='brand' id='brand' href='/'>Twitter analysis</a>
					<a class='btn primary pull-left' id='networkgenerator'>Generate a network</a>
					<ul id='running' class='nav hide pull-left'>
						<li><a href='#' class='start'>start</a></li>
						<li><a href='#' class='stop'>stop</a></li>
					</ul>
					<ul class='nav pull-left'>
						<li><a href='#' class='strongconnections'>strong connections</a></li>
						<li><a href='#' class='newnetwork hide'>create network with ...</a></li>
					</ul>
					<p class='pull-right'>Currently analyzing <span id='currentuser'>no one</span></p>
				</div>
			</div>
		</div>
		<div id="modal-network-generator" class="modal hide fade">
			<div class="modal-header">
				<a href="#" class="close">x</a>
				<h3>Hi, let's generate a network</h3>
			</div>
			<div class="modal-body">
				<form id='addProtagonist'>
					<div class="clearfix">
						<label for="prependedInput">Add a person</label>
						<div class="input">
							<div class="input-prepend">
								<span class="add-on">@</span>
								<input class="medium" id="addProtagonistText" name="prependedInput" size="32" type="text">
								<input type='submit' class='btn' href='#' value='+'/>
							</div>
						</div>
					</div>
				</form>
				<div><p>&nbsp;</p></div>
				<table id='protagonists' class='zebra-striped'>
					<thead>
						<tr>
							<th>name</th>
							<th>followers</th>
							<th>following</th>
							<th>self</th>
							<th>remove</th>
						</tr>
					</thead>
					<tbody>
						<tr class='dummyrow hide'>
							<td class='name'></td>
							<td class='followers'>
								<div class="clearfix">
									<div class="input">
										<div class="input-append">
											<input class="mini" disabled='disabled' name="appendedInput" size="16" type="text">
											<label class="add-on"><input type="checkbox" rel='includefollowers'></label>
										</div>
									</div>
								</div>
							</td>
							<td class='friends'>
								<div class="clearfix">
									<div class="input">
										<div class="input-append">
											<input class="mini" disabled='disabled' name="appendedInput" size="16" type="text">
											<label class="add-on"><input type="checkbox" rel='includefriends'></label>
										</div>
									</div>
								</div>
							</td>
							<td class='self'><input type="checkbox" rel='includeself'></td>
							<td class='removerow'><a class='btn rmprotagonist'>-</a></td>
						</tr>					
					</tbody>
				</table>
				<div class='slider hide' id='thresholdslider'></div>
			</div>
			<div class="modal-footer">
				<span>Your network will consist of <span class='tweepcount'>0</span> tweeps</span>
				<a href="#" class="btn primary disabled" id='downloadbtn'>Download the connections</a>
			</div>
		</div>
		<div id="modal-tweep-downloader" class="modal hide fade">
			<div class="modal-header">
				<a href="#" class="close">x</a>
				<h3>Tweep downloader</h3>
			</div>
			<div class="modal-body">
				<div id='downloadsphase1'>
					<p><b>Phase 1:</b> Downloading the profiles</p>
					<p>Total: <span class='tweepcount'>0</span>, already in cache: <span class='tweepProfilesCached'>0</span>, downloaded: <span class='tweepProfilesParsed'>0</span></p>
				</div>
				<div id='downloadsphase2' class='hide'>
					<p><b>Phase 2:</b> Downloading the connections</p>
					<p>there are <span class='privateaccounts'>0</span> private accounts</p>
					<table id='downloads' class='zebra-striped'>
						<thead>
							<tr>
								<th>source</th>
								<th>limit</th>
								<th>total</th>
								<th>requested</th>
								<th>retrieved</th>
								<th>failed</th>
							</tr>
						</thead>
						<tbody>
							<tr class='' id='downloads0'>
								<td class='name'>local cache</td>
								<td>n/a</td>
								<td class='total tweepcount'>0</td>
								<td class='requested'>0</td>
								<td class='retrieved'>0</td>
								<td style="color: red;" class='error'></td>
								<td><img class='loading_small hide' src='img/loading_small.gif'/></td>
							</tr>
							<tr class='' id='downloads1'>
								<td class='name'>server cache</td>
								<td>n/a</td>
								<td class='total'>0</td>
								<td class='requested'>0</td>
								<td class='retrieved'>0</td>
								<td style="color: red;" class='error'></td>
								<td><img class='loading_small hide' src='img/loading_small.gif'/></td>
							</tr>
							<tr class='' id='downloads2'>
								<td class='name'>yahoo pipes</td>
								<td>+/- 200/hour</td>
								<td class='total'>0</td>
								<td class='requested'>0</td>
								<td class='retrieved'>0</td>
								<td style="color: red;" class='error'></td>
								<td><img class='loading_small hide' src='img/loading_small.gif'/></td>
							</tr>
							<tr class='' id='downloads3'>
								<td class='name'>twitter</td>
								<td>150/hour</td>
								<td class='total'>0</td>
								<td class='requested'>0</td>
								<td class='retrieved'>0</td>
								<td style="color: red;" class='error'></td>
								<td><img class='loading_small hide' src='img/loading_small.gif'/></td>
							</tr>
						</tbody>
					</table>
				</div>

				<div style='text-align: center;' id='progress'><img src='img/loading.gif'/></div>
				<div id='pleasecomeback'>
					<p><b>It seems that you've reached twitter's download limit.</b></p>
					<p>Please come back in <b>one hour</b>. The results you just downloaded are cached on our server.</p>
					<p>If most of the results are in, you can try to start the analysis nevertheless.</p>
				</div>
			</div>
			<div class="modal-footer">
				<a href="#" class="btn primary disabled" id='configurebtn'>Configure</a>
			</div>
		</div>
		<div id="modal-connection-configurator" class="modal hide fade">
			<div class="modal-header">
				<a href="#" class="close">x</a>
				<h3>Connection strengths</h3>
			</div>
			<div class="modal-body">
				<p>Each tweep (A) pulls all tweeps he follows (B) towards himself. The amount of pull from A on each B is based on the following rules:</p>
				<div class='slider' data-tag='friendscore' data-caption="Single following" data-text="If A follows B, the pull gets .. points." data-min="0" data-max="10" data-step="1" data-default="0.5"></div>
				<div class='slider' data-tag='mutualscore' data-caption="Emphasize mutual following" data-text="If A follows B and B follows A, add .. points." data-min="0" data-max="10" data-step="0.5" data-default="3"></div>
				<div class='slider' data-tag='commonscore' data-caption="Common interests" data-text="Tweeps that both A and B follow, add .. points." data-min="0" data-max="2" data-step="0.1" data-default="0.5"></div>
				<div class='slider' data-tag='closefriendthreshold' data-caption="Threshold" data-text="Ignore connections with less than .. points." data-min="0" data-max="10" data-step="0.5" data-default="2"></div>
				<div class='checkbox' data-tag='assume_mutual_when_protected' data-caption="Protected accounts" data-text="Assume that protected accounts follow their followers" data-default="true"></div>
			</div>
			<div class="modal-footer">
				<a href="#" class="btn primary disabled" id='analysebtn'>Analyse</a>
			</div>
		</div>
		<div id='playfield'>
		</div>
	</body>
</html>
